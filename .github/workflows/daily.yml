name: Auto Deploy Stock Report v1.5.4

on:
  push:
    branches:
      - main
  schedule:
    # 台灣時間 (CST) 週二至週六 06:00 AM 執行
    # 對應 UTC 時間週一至週五 22:00
    - cron: '0 22 * * 1-5'
  workflow_dispatch: # 保留手動觸發按鈕

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 獲取完整歷史以利 Commit

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          pip install pandas yfinance requests beautifulsoup4 plotly kaleido google-genai pytz

      - name: Run Analysis
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: python app_cron.py

      - name: Commit and Push History
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          mkdir -p history
          git add index.html history/*.html
          # 如果檔案沒有變動（例如休市），則不執行 commit 並跳過，避免流程報錯
          git commit -m "Automated Report Update: $(date +'%Y-%m-%d %H:%M') (CST)" || echo "No changes to commit"
          git push origin main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
